<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Movie & TV List (TMDb)</title>
  <meta name="description" content="Add films and TV shows by searching TMDb. Click a result to add it with poster, description and trailer." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><text y='1em' font-size='96'>üé¨</text></svg>">
  <style>
    :root {
      --bg: #0b0c0f; /* deep blue-black */
      --panel: #12141a;
      --text: #e6e8f0;
      --muted: #9aa3b2;
      --accent: #6ee7b7;
      --accent-2: #93c5fd;
      --danger: #fca5a5;
      --ring: #334155;
      --card: #0f172a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: radial-gradient(1000px 600px at 10% -10%, rgba(147,197,253,.15), transparent), radial-gradient(800px 500px at 110% 10%, rgba(110,231,183,.12), transparent), var(--bg); color: var(--text); display: grid; grid-template-rows: auto 1fr auto; min-height: 100dvh; }
    header { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(8px); background: color-mix(in lab, var(--bg) 70%, transparent); border-bottom: 1px solid #1f2937; }
    .container { max-width: 980px; margin: 0 auto; padding: 16px }
    .title { display: flex; gap: 12px; align-items: center }
    .title h1 { margin: 0; font-weight: 800; letter-spacing: .2px; font-size: clamp(22px, 5vw, 30px) }
    .subtitle { margin: 6px 0 0; color: var(--muted); font-size: 14px }
    .searchbar { position: relative; margin-top: 14px }
    .searchbar input[type="text"] { width: 100%; padding: 14px 48px 14px 16px; border-radius: 14px; background: var(--panel); color: var(--text); border: 1px solid #1f2937; outline: none; font-size: 16px; box-shadow: inset 0 1px 0 rgba(255,255,255,.02), var(--shadow); }
    .searchbar input:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px rgba(147,197,253,.12), var(--shadow) }
    .searchbar .kbd { position:absolute; right:10px; top:50%; transform: translateY(-50%); font: 12px/1 monospace; color: var(--muted); opacity:.9 }
    .suggestions { position: absolute; inset: auto 0 0 0; transform: translateY(100%); background: var(--panel); border: 1px solid #1f2937; border-radius: 12px; margin-top: 8px; max-height: 60dvh; overflow: auto; box-shadow: var(--shadow); display: none; }
    .suggestions.open { display: block }
    .suggestion { display: grid; grid-template-columns: 46px 1fr auto; gap: 12px; align-items: center; padding: 10px 12px; cursor: pointer }
    .suggestion:hover, .suggestion[aria-selected="true"] { background: #0b1220 }
    .suggestion img { width: 46px; height: 68px; object-fit: cover; border-radius: 8px; background: #0b1220 }
    .suggestion .meta { display:flex; flex-direction:column; gap:4px }
    .pill { font-size: 12px; color: var(--muted); padding: 2px 8px; border: 1px solid #374151; border-radius: 999px }
    main .container { padding-top: 10px }
    .list { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px }
    @media (max-width: 900px) { .list { grid-template-columns: repeat(6, 1fr) } }
    @media (max-width: 640px) { .list { grid-template-columns: repeat(4, 1fr) } }
    .card { grid-column: span 4; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)) , var(--card); border: 1px solid #1f2937; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); display:flex; flex-direction: column }
    .card.wide { grid-column: span 6 }
    @media (max-width: 640px) { .card, .card.wide { grid-column: span 4 } }
    .poster { width: 100%; aspect-ratio: 3 / 4.2; object-fit: cover; background:#0b1220 }
    .content { padding: 12px 14px 16px }
    .row { display:flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 6px 0 }
    .actions { margin-top: auto; display:flex; justify-content: space-between; align-items: center; gap: 8px; padding: 12px 14px; border-top:1px solid #1f2937; background: #0c111b; flex-wrap: wrap }
    button, .btn { appearance: none; border: 1px solid #2b3443; background: #111827; color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: var(--shadow) }
    button:hover { background: #0f172a; border-color:#3b475a }
    .btn-ghost { background: transparent; border-color: #374151 }
    .btn-danger { border-color: #7f1d1d; background: #1f0f12 }
    .btn-danger:hover { background: #2b0f12; border-color:#991b1b }
    footer { color: var(--muted); font-size: 12px; border-top: 1px solid #1f2937 }
    a { color: var(--accent-2); text-decoration: none }
    a:hover { text-decoration: underline }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <div style="font-size:26px">üé¨</div>
        <div>
          <h1>Movie & TV List</h1>
          <p class="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–ø–∏—Å–æ–∫ –Ω–µ–ø—Ä–æ—Ö–æ–¥–Ω—è–∫–æ–≤ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –õ–µ–æ–Ω–∏–¥–æ–º</p>
        </div>
      </div>
      <div class="searchbar" role="combobox" aria-expanded="false" aria-owns="suggestion-list">
        <input id="search" type="text" placeholder="Search for a film or show‚Ä¶" autocomplete="off" aria-autocomplete="list" aria-controls="suggestion-list" />
        <span class="kbd">Enter ‚Üµ</span>
        <div id="suggestions" class="suggestions" role="listbox" aria-label="Search suggestions"></div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="list" class="list" aria-live="polite"></div>
    </div>
  </main>

  <footer>
    <div class="container">
      Data from TMDb (The Movie Database). This product uses the TMDb API but is not endorsed or certified by TMDb.
    </div>
  </footer>

  <script>
  // ======= CONFIG =======
  const TMDB_API_KEY = "166bdfecdc09d46826d8662b9627ad27"; // TMDb API Key
  const TMDB_IMG_BASE = "https://image.tmdb.org/t/p/"; // TMDb image base URL
  const LANGUAGE = "ru"; // Russian language for TMDb
  const YOUTUBE_API_KEY = "AIzaSyCUHWrkVFi1UO1y8NKSkWtrT_W1aZpdBDM"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à YouTube API-–∫–ª—é—á
  const SEARCH_DELAY_MS = 350;

  // ======= STATE =======
  const state = {
    items: /** @type {Record<string, any>} */ ({}), // key `${type}_${id}` -> details
    order: /** @type {string[]} */ ([]),
    selectedIndex: -1,
    suggestions: [],
  };

  // ======= ELEMENTS =======
  const el = {
    search: document.getElementById('search'),
    suggestions: document.getElementById('suggestions'),
    list: document.getElementById('list'),
  };

  // ======= UTIL =======
  const debounce = (fn, ms) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); } };
  const esc = (s) => String(s || "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  const byId = (id) => document.getElementById(id);

  function save() {
    localStorage.setItem('tmdbList.v1', JSON.stringify({items: state.items, order: state.order}));
  }
  function load() {
    try {
      const raw = localStorage.getItem('tmdbList.v1');
      if (!raw) return;
      const data = JSON.parse(raw);
      if (data && data.items && data.order) { state.items = data.items; state.order = data.order; renderList(); }
    } catch (e) { console.warn('Failed to load saved list', e); }
  }

  function apiUrl(path, params={}) {
    const base = new URL('https://api.themoviedb.org/3' + path);
    const sp = new URLSearchParams({ api_key: TMDB_API_KEY, language: LANGUAGE, ...params });
    base.search = sp.toString();
    return base.toString();
  }

  function imgUrl(path, size='w500') {
    if (!path) return '';
    return `${TMDB_IMG_BASE}${size}${path}`;
  }

  // ======= YouTube API =======
  async function searchYouTubeTrailer(title) {
    const query = `${encodeURIComponent(title)} —Ç—Ä–µ–π–ª–µ—Ä —Ä—É—Å—Å–∫–∏–π`;
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&key=${YOUTUBE_API_KEY}&regionCode=RU&maxResults=1&type=video`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      if (data.items && data.items.length > 0) {
        return `https://www.youtube.com/watch?v=${data.items[0].id.videoId}`;
      }
      return null;
    } catch (error) {
      console.warn('YouTube API error:', error);
      return null;
    }
  }

  // ======= TMDb API =======
  async function searchMulti(q) {
    if (!TMDB_API_KEY || TMDB_API_KEY.includes('PASTE')) {
      return { Error: 'Missing TMDb API key. Create a free account at themoviedb.org, then paste your key at the top of this file.' };
    }
    const url = apiUrl('/search/multi', { query: q, include_adult: 'false' });
    const res = await fetch(url);
    const data = await res.json();
    if (!data || !data.results) return { results: [] };
    const items = data.results.filter(r => r.media_type === 'movie' || r.media_type === 'tv').slice(0, 12);
    return { results: items };
  }

  async function fetchDetails(type, id) {
    const url = apiUrl(`/${type}/${id}`, { append_to_response: 'videos' });
    const res = await fetch(url);
    return await res.json();
  }

  function openSuggestions(items) {
    state.suggestions = items;
    el.suggestions.innerHTML = items.map((it, idx) => {
      const title = it.title || it.name || '';
      const year = (it.release_date || it.first_air_date || '').slice(0,4);
      const poster = it.poster_path ? imgUrl(it.poster_path, 'w154') : '';
      return `<div class="suggestion" role="option" data-type="${esc(it.media_type)}" data-id="${esc(it.id)}" aria-selected="${idx===state.selectedIndex}">
        <img src="${esc(poster)}" alt="" loading="lazy" />
        <div class="meta">
          <div style="font-weight:700">${esc(title)}</div>
          <div class="pill">${esc(year || '')}</div>
        </div>
        <div class="pill">${esc(it.media_type)}</div>
      </div>`;
    }).join('');
    el.suggestions.classList.add('open');
    document.querySelector('.searchbar').setAttribute('aria-expanded', 'true');
  }
  function closeSuggestions() {
    el.suggestions.classList.remove('open');
    document.querySelector('.searchbar').setAttribute('aria-expanded', 'false');
    state.selectedIndex = -1; state.suggestions = [];
  }

  function renderList() {
    if (!state.order.length) { el.list.innerHTML = `<div class="card wide"><div class="content"><h3 style="margin:6px 0 6px">Your list is empty</h3><p class="subtitle">Search above and click a result to add a movie or TV show.</p></div></div>`; return; }
    el.list.innerHTML = state.order.map(key => {
      const m = state.items[key];
      const poster = m.poster_path ? imgUrl(m.poster_path, 'w500') : '';
      const title = m.title || m.name || '';
      const year = (m.release_date || m.first_air_date || '').slice(0,4) || '';
      const genres = (m.genres || []).slice(0,3).map(g=>`<span class="pill">${esc(g.name)}</span>`).join('');
      const rating = (m.vote_average && m.vote_count > 0) ? `‚≠ê${Number(m.vote_average).toFixed(1)}` : '';
      const runtime = (m.runtime ? `${m.runtime} min` : (Array.isArray(m.episode_run_time) && m.episode_run_time[0]) ? `${m.episode_run_time[0]} min` : '');
      return `<article class="card">
        <img class="poster" src="${esc(poster)}" alt="Poster for ${esc(title)}" loading="lazy" />
        <div class="content">
          <h3 style="margin:0 0 6px">${esc(title)} ${year ? `<span class=\"pill\" style=\"margin-left:6px\">${esc(year)}</span>`:''}</h3>
          <div class="row">${genres}</div>
          <p style="color:var(--muted); line-height:1.5; margin: 8px 0 0">${esc(m.overview || 'No description.')}</p>
        </div>
        <div class="actions">
          <div class="row" style="gap:8px">
            ${rating ? `<span class="pill">${esc(rating)}</span>` : ''}
            ${runtime ? `<span class="pill">${esc(runtime)}</span>` : ''}
            <span class="pill">${esc(m.media_type.toUpperCase())}</span>
          </div>
          <div class="row" style="gap:8px">
            <a class="btn" id="trailer-${esc(key)}" href="#" target="_blank" rel="noreferrer">Trailer ‚ñ∂</a>
            <button class="btn-ghost" data-remove="${esc(key)}" title="Remove">Remove</button>
          </div>
        </div>
      </article>`;
    }).join('');
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ç—Ä–µ–π–ª–µ—Ä–æ–≤
    state.order.forEach(key => {
      const btn = document.getElementById(`trailer-${key}`);
      if (btn) {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const m = state.items[key];
          const title = m.title || m.name || '';
          const trailerUrl = await searchYouTubeTrailer(title);
          if (trailerUrl) {
            window.open(trailerUrl, '_blank');
          } else {
            alert('–†—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π —Ç—Ä–µ–π–ª–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.');
          }
        });
      }
    });
  }

  function bestTrailerUrl(details) {
    const vids = details?.videos?.results || [];
    const pick = vids.find(v => v.site === 'YouTube' && v.type === 'Trailer' && v.official && v.iso_639_1 === 'ru')
      || vids.find(v => v.site === 'YouTube' && v.type === 'Trailer' && v.iso_639_1 === 'ru')
      || vids.find(v => v.site === 'YouTube' && v.type === 'Teaser' && v.iso_639_1 === 'ru');
    return pick ? `https://www.youtube.com/watch?v=${pick.key}` : '';
  }

  async function addItem(type, id) {
    const key = `${type}_${id}`;
    if (state.items[key]) return;
    const m = await fetchDetails(type, id);
    if (m && !m.status_code) {
      m.media_type = type;
      state.items[key] = m;
      state.order.unshift(key);
      save();
      renderList();
    }
  }

  // ======= EVENT WIRING =======
  const doSearch = debounce(async () => {
    const q = el.search.value.trim();
    if (!q) { closeSuggestions(); return; }
    const data = await searchMulti(q);
    if (!data || data.Error) {
      el.suggestions.innerHTML = `<div class="suggestion" aria-disabled="true">${esc(data?.Error || 'No results')}</div>`;
      el.suggestions.classList.add('open');
      return;
    }
    openSuggestions(data.results);
  }, SEARCH_DELAY_MS);

  el.search.addEventListener('input', doSearch);
  el.search.addEventListener('keydown', (e) => {
    if (!el.suggestions.classList.contains('open')) return;
    const max = state.suggestions.length - 1;
    if (e.key === 'ArrowDown') { e.preventDefault(); state.selectedIndex = Math.min(max, state.selectedIndex + 1); highlight(); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); state.selectedIndex = Math.max(0, state.selectedIndex - 1); highlight(); }
    else if (e.key === 'Enter') {
      if (state.selectedIndex >= 0) {
        const sel = state.suggestions[state.selectedIndex]; if (sel) addItem(sel.media_type, sel.id);
      } else if (state.suggestions[0]) {
        const sel = state.suggestions[0]; addItem(sel.media_type, sel.id);
      }
      closeSuggestions();
      el.search.select();
    } else if (e.key === 'Escape') { closeSuggestions(); }
  });

  function highlight() {
    [...el.suggestions.querySelectorAll('.suggestion')].forEach((n, i) => n.setAttribute('aria-selected', String(i === state.selectedIndex)));
  }

  el.suggestions.addEventListener('click', (e) => {
    const item = e.target.closest('.suggestion');
    if (!item) return;
    const id = item.getAttribute('data-id');
    const type = item.getAttribute('data-type');
    if (id && type) { addItem(type, id); closeSuggestions(); el.search.select(); }
  });

  document.addEventListener('click', (e) => {
    if (!document.querySelector('.searchbar').contains(e.target)) closeSuggestions();
  });

  el.list.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-remove]');
    if (!btn) return;
    const key = btn.getAttribute('data-remove');
    delete state.items[key];
    state.order = state.order.filter(x => x !== key);
    save();
    renderList();
  });

  // Initial render
  load();
  renderList();
  </script>
</body>
</html>
