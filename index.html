<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–ø–∏—Å–æ–∫ —à–µ–¥–µ–≤—Ä–æ–≤ (TMDb)</title>
  <meta name="description" content="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–ø–∏—Å–æ–∫ –Ω–µ –ø—Ä–æ—Ö–æ–¥–Ω—è–∫–æ–≤, —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –õ–µ–æ–Ω–∏–¥–æ–º" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><text y='1em' font-size='96'>üé¨</text></svg>">

  <!--
    =====================================================================
    –°–¢–ò–õ–ò
    =====================================================================
    –í–∞–∂–Ω–æ:
    - –í–∏–∑—É–∞–ª—å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç —Ñ–æ–Ω–∞
    - –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    - –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–æ–∫
    - –ö–ª–∞—Å—Å—ã –¥–ª—è dnd: .noselect, .dragging, .removing
  -->
  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #12141a;
      --text: #e6e8f0;
      --muted: #9aa3b2;
      --accent: #6ee7b7;
      --accent-2: #93c5fd;
      --danger: #fca5a5;
      --ring: #334155;
      --card: #0f172a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      /* Darker gradient + faster animation */
      background: linear-gradient(-45deg, #0f172a, #1e293b, #111827, #0b0c0f);
      background-size: 400% 400%;
      background-attachment: fixed;
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100dvh;
      animation: gradient 8s ease infinite;
    }
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    header { background: color-mix(in lab, var(--bg) 70%, transparent); border-bottom: 1px solid #1f2937 }
    .container { max-width: 980px; margin: 0 auto; padding: 16px }
    .title { display: flex; gap: 12px; align-items: center }
    .title h1 { margin: 0; font-weight: 800; letter-spacing: .2px; font-size: clamp(22px, 5vw, 30px) }
    .subtitle { margin: 6px 0 0; color: var(--muted); font-size: 14px }

    .searchbar { position: relative; margin-top: 14px }
    .searchbar input[type="text"] {
      width: 100%;
      padding: 14px 48px 14px 16px;
      border-radius: 14px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid #1f2937;
      outline: none;
      font-size: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.02), var(--shadow)
    }
    .searchbar input:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px rgba(147,197,253,.12), var(--shadow) }
    .searchbar .kbd {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      font: 12px/1 monospace; color: var(--muted); opacity: .9
    }

    .suggestions {
      position: absolute; inset: auto 0 0 0; transform: translateY(100%);
      background: var(--panel); border: 1px solid #1f2937; border-radius: 12px;
      margin-top: 8px; max-height: 60dvh; overflow: auto; box-shadow: var(--shadow);
      display: none; z-index: 100
    }
    .suggestions.open { display: block }
    .suggestion {
      display: grid; grid-template-columns: 46px 1fr auto; gap: 12px;
      align-items: center; padding: 10px 12px; cursor: pointer
    }
    .suggestion:hover, .suggestion[aria-selected="true"] { background: #0b1220 }
    .suggestion img { width: 46px; height: 68px; object-fit: cover; border-radius: 8px; background: #0b1220 }
    .suggestion .meta { display: flex; flex-direction: column; gap: 4px }
    .pill { font-size: 12px; color: var(--muted); padding: 2px 8px; border: 1px solid #374151; border-radius: 999px }

    main .container { padding-top: 10px }
    .list {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 900px) { .list { grid-template-columns: repeat(6, 1fr) } }
    @media (max-width: 640px) { .list { grid-template-columns: repeat(4, 1fr) } }

    .card {
      grid-column: span 4;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card);
      border: 1px solid #1f2937;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow), 0 0 10px rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
    }
    .sortable .card { cursor: grab }
    .card.wide { grid-column: span 6 }
    @media (max-width: 640px) { .card, .card.wide { grid-column: span 4 } }

    .poster { width: 100%; aspect-ratio: 3 / 4.2; object-fit: cover; background: #0b1220 }
    .content { padding: 12px 14px 16px; flex: 0 0 auto; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 6px 0 }
    .description {
      color: var(--muted);
      line-height: 1.5;
      margin: 6px 0 0;
      font-size: 14px;
    }

    .actions {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      border-top: 1px solid #1f2937;
      background: #0c111b;
      flex-wrap: wrap
    }
    button, .btn {
      appearance: none;
      border: 1px solid #2b3443;
      background: #111827;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: var(--shadow)
    }
    button:hover { background: #0f172a; border-color: #3b475a }

    .btn-ghost {
      background: transparent;
      border: 1px solid #374151;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      text-align: center;
      line-height: 1.5;
      padding: 10px 14px;
      border-radius: 12px;
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      box-sizing: border-box;
      min-width: 80px;
      font-size: 16px
    }
    .btn-ghost:hover { background: #0f172a; border-color: #3b475a }

    .btn-danger { border-color: #7f1d1d; background: #1f0f12 }
    .btn-danger:hover { background: #2b0f12; border-color: #991b1b }

    footer { color: var(--muted); font-size: 12px; border-top: 1px solid #1f2937 }
    a { color: var(--accent-2); text-decoration: none }
    a:hover { text-decoration: underline }

    .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100 }
    .modal-content { background: var(--card); padding: 10px 20px 20px; border-radius: var(--radius); border: 1px solid #1f2937; box-shadow: var(--shadow); width: 90%; max-width: 400px; text-align: center }
    .modal-content p { margin: 0 0 15px; color: var(--muted); font-size: 16px }
    .modal-actions, .edit-actions { display: flex; justify-content: center; gap: 10px }

    @media (max-width: 640px) {
      .modal-content { max-width: 90%; padding: 15px }
      .modal-content p { font-size: 14px }
      .modal-actions button, .modal-actions .btn { padding: 8px 12px; font-size: 14px }
    }

    .edit-modal-content {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid #1f2937;
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 500px;
      text-align: center
    }
    .edit-modal-content h3 { margin: 0 0 15px; color: var(--text) }
    .edit-modal-content input {
      width: 100%; padding: 10px; margin-bottom: 15px;
      border: 1px solid #1f2937; border-radius: 8px;
      background: var(--panel); color: var(--text); font-size: 14px
    }
    .edit-modal-content input:focus { border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(147,197,253,.12) }

    .loader {
      border: 8px solid #0b0c0f;
      border-top: 8px solid #6ee7b7;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%)
    }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg) } 100% { transform: translate(-50%, -50%) rotate(360deg) } }
    #list.loading { display: none }

    /* DnD helpers */
    body.noselect { user-select: none }
    .card.dragging { opacity: 0.6; cursor: grabbing; }
    .card.removing { opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0s linear 0.5s; }

    /* –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏) */
    .drop-indicator {
      height: 0; border-top: 2px dashed rgba(255,255,255,.25);
      grid-column: 1 / -1;
      margin: -6px 0;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <div style="font-size:26px">üé¨</div>
        <div>
          <h1>–°–ø–∏—Å–æ–∫ —à–µ–¥–µ–≤—Ä–æ–≤</h1>
          <p class="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–ø–∏—Å–æ–∫ –Ω–µ –ø—Ä–æ—Ö–æ–¥–Ω—è–∫–æ–≤, —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –õ–µ–æ–Ω–∏–¥–æ–º</p>
        </div>
      </div>

      <!-- –ü–æ–∏—Å–∫ -->
      <div class="searchbar" id="searchbar" role="combobox" aria-expanded="false" aria-owns="suggestion-list">
        <input id="search" type="text" placeholder="Search for a film or show‚Ä¶" autocomplete="off" aria-autocomplete="list" aria-controls="suggestion-list" />
        <span class="kbd">Enter ‚Üµ</span>
        <div id="suggestions" class="suggestions" role="listbox" aria-label="Search suggestions"></div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="loader-container">
        <div id="loader" class="loader"></div>
        <div id="list" class="list loading" aria-live="polite"></div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      Data from TMDb (The Movie Database). This product uses the TMDb API but is not endorsed or certified by TMDb.
    </div>
  </footer>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
  <div id="modal" class="modal" aria-modal="true" role="dialog" aria-labelledby="modal-title">
    <div class="modal-content">
      <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <strong id="modal-title"></strong>?</p>
      <div class="modal-actions">
        <button class="btn btn-danger" id="confirm-delete">–î–∞</button>
        <button class="btn btn-ghost" id="cancel-delete">–ù–µ—Ç</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–π–ª–µ—Ä–∞ -->
  <div id="edit-modal" class="modal" aria-modal="true" role="dialog" aria-labelledby="edit-title">
    <div class="edit-modal-content">
      <h3 id="edit-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–π–ª–µ—Ä</h3>
      <input type="text" id="trailer-link-input" placeholder="–í–≤–µ–¥–∏—Ç–µ URL —Ç—Ä–µ–π–ª–µ—Ä–∞" />
      <div class="edit-actions">
        <button class="btn btn-danger" id="save-trailer">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-ghost" id="cancel-edit">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <!--
    =====================================================================
    –°–ö–†–ò–ü–¢ (type="module")
    =====================================================================
    –ü–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
    - TMDB search + details
    - YouTube trailer –ø–æ–∏—Å–∫
    - Firebase Realtime Database sync
    - –ü–û–õ–ù–û–°–¢–¨–Æ –ß–ò–°–¢–´–ô JS Drag & Drop –¥–ª—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
    - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É (allowedDevice)
  -->
  <script type="module">
    'use strict';

    /* ==============================
       –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ö–û–ù–§–ò–ì
       ============================== */
    const TMDB_API_KEY = "166bdfecdc09d46826d8662b9627ad27";
    const TMDB_IMG_BASE = "https://image.tmdb.org/t/p/";
    const LANGUAGE = "ru";
    const YOUTUBE_API_KEY = "AIzaSyCUHWrkVFi1UO1y8NKSkWtrT_W1aZpdBDM";
    const SEARCH_DELAY_MS = 350;

    // –†–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (ID|UA)
    const ALLOWED_DEVICE_ID = "30a62442-ecd5-4abf-9b51-22b34ae85d2e|Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36";

    /* ==============================
       FIREBASE (v12 SDK, –º–æ–¥—É–ª—å–Ω–æ)
       ============================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDu8R38EkqOxBDkcgfnYf5mBTCosQsOoGA",
      authDomain: "my-movie-tv-lis.firebaseapp.com",
      projectId: "my-movie-tv-lis",
      storageBucket: "my-movie-tv-lis.firebasestorage.app",
      messagingSenderId: "470112487115",
      appId: "1:470112487115:web:a0dba8f948514eaf3e3d4e",
      measurementId: "G-JLCYQH6XEE"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    /* ==============================
       –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
       ============================== */
    const state = {
      items: /** @type {Record<string, any>} */ ({}),
      order: /** @type {string[]} */ ([]),
      selectedIndex: -1,
      suggestions: [],
    };

    // –§–ª–∞–≥–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ dnd
    let isDragging = false;          // –∏–¥—ë—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    let suppressRemote = false;      // –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–∏—è remote-—Å–Ω–∞–ø—à–æ—Ç–∞ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ save()
    let localUpdatedAt = 0;          // —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–∏—Ä–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–º–∏ remote-–¥–∞–Ω–Ω—ã–º–∏
    let dragIndicator = null;        // DOM-—ç–ª–µ–º–µ–Ω—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤—Å—Ç–∞–≤–∫–∏ –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏

    /* ==============================
       –£–¢–ò–õ–ò–¢–´
       ============================== */
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => [...ctx.querySelectorAll(sel)];
    const esc = (s="") => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t=setTimeout(() => fn(...a), ms); }; };

    const el = {
      searchbar: $('#searchbar'),
      search: $('#search'),
      suggestions: $('#suggestions'),
      list: $('#list'),
      loader: $('#loader'),
      modal: $('#modal'),
      modalTitle: $('#modal-title'),
      confirmDelete: $('#confirm-delete'),
      cancelDelete: $('#cancel-delete'),
      editModal: $('#edit-modal'),
      trailerInput: $('#trailer-link-input'),
      saveTrailer: $('#save-trailer'),
      cancelEdit: $('#cancel-edit'),
    };

    /* ==============================
       –£–°–¢–†–û–ô–°–¢–í–û –ò –†–ê–ó–†–ï–®–ï–ù–ò–ï
       ============================== */
    function getDeviceId() {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        deviceId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
        });
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId + '|' + navigator.userAgent;
    }
    const allowedDevice = getDeviceId() === ALLOWED_DEVICE_ID;
    if (allowedDevice) el.list.classList.add('sortable');

    /* ==============================
       API TMDb / YouTube
       ============================== */
    function apiUrl(path, params = {}) {
      const base = new URL('https://api.themoviedb.org/3' + path);
      const sp = new URLSearchParams({ api_key: TMDB_API_KEY, language: LANGUAGE, ...params });
      base.search = sp.toString();
      return base.toString();
    }
    const imgUrl = (path, size='w500') => path ? `${TMDB_IMG_BASE}${size}${path}` : '';

    async function searchYouTubeTrailer(title) {
      const q = `${encodeURIComponent(title)} —Ç—Ä–µ–π–ª–µ—Ä —Ä—É—Å—Å–∫–∏–π`;
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&key=${YOUTUBE_API_KEY}&regionCode=RU&maxResults=1&type=video`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data?.items?.length) return `https://www.youtube.com/watch?v=${data.items[0].id.videoId}`;
      } catch (e) {
        console.warn('YouTube API error:', e);
      }
      return null;
    }

    async function searchMulti(q) {
      if (!TMDB_API_KEY) return { results: [] };
      const url = apiUrl('/search/multi', { query: q, include_adult: 'false' });
      try {
        const res = await fetch(url);
        if (!res.ok) return { results: [] };
        const data = await res.json();
        const items = (data?.results||[]).filter(r=>r.media_type==='movie'||r.media_type==='tv').slice(0,12);
        return { results: items };
      } catch (e) {
        console.warn('TMDb search error:', e);
        return { results: [] };
      }
    }

    async function fetchDetails(type, id) {
      const url = apiUrl(`/${type}/${id}`, { append_to_response: 'videos' });
      const res = await fetch(url);
      return await res.json();
    }

    function bestTrailerUrl(details) {
      const vids = details?.videos?.results || [];
      const pick = vids.find(v => v.site==='YouTube' && v.type==='Trailer' && v.official && v.iso_639_1==='ru')
        || vids.find(v => v.site==='YouTube' && v.type==='Trailer' && v.iso_639_1==='ru')
        || vids.find(v => v.site==='YouTube' && v.type==='Teaser' && v.iso_639_1==='ru');
      return pick ? `https://www.youtube.com/watch?v=${pick.key}` : '';
    }

    /* ==============================
       PERSIST (Firebase)
       ============================== */
    function save() {
      const payload = { items: state.items, order: state.order, updatedAt: Date.now(), device: getDeviceId() };
      localUpdatedAt = payload.updatedAt;
      suppressRemote = true;
      setTimeout(() => { suppressRemote = false; }, 800);
      set(ref(database, 'tmdbList'), payload)
        .catch(err => console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err));
    }

    function subscribe() {
      onValue(ref(database, 'tmdbList'), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        // –∏–≥–Ω–æ—Ä –≤–æ –≤—Ä–µ–º—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏–ª–∏ –≤ –æ–∫–Ω–æ –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è
        if (isDragging || suppressRemote) return;
        if ((data.updatedAt ?? 0) < localUpdatedAt) return;

        state.items = data.items || {};
        state.order = data.order || [];

        // –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç—Ä–µ–π–ª–µ—Ä (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
        for (const k of Object.keys(state.items)) {
          const m = state.items[k];
          if (!m.customTrailerUrl) m.customTrailerUrl = bestTrailerUrl(m) || '';
        }
        renderList();
      }, (error) => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error));
    }

    /* ==============================
       –†–ï–ù–î–ï–†–ò–ù–ì
       ============================== */
    function openSuggestions(items) {
      state.suggestions = items;
      el.suggestions.innerHTML = items.map((it, idx) => {
        const title = it.title || it.name || '';
        const year = (it.release_date || it.first_air_date || '').slice(0,4);
        const poster = it.poster_path ? imgUrl(it.poster_path, 'w154') : '';
        return `<div class="suggestion" role="option" data-type="${esc(it.media_type)}" data-id="${esc(it.id)}" aria-selected="${idx===state.selectedIndex}">
          <img src="${esc(poster)}" alt="" loading="lazy" />
          <div class="meta">
            <div style="font-weight:700">${esc(title)}</div>
            <div class="pill">${esc(year||'')}</div>
          </div>
          <div class="pill">${esc(it.media_type)}</div>
        </div>`;
      }).join('');
      el.suggestions.classList.add('open');
      el.searchbar.setAttribute('aria-expanded', 'true');
    }

    function closeSuggestions() {
      el.suggestions.classList.remove('open');
      el.searchbar.setAttribute('aria-expanded', 'false');
      state.selectedIndex = -1; state.suggestions = [];
    }

    function cardTemplate(m, key) {
      const poster = m.poster_path ? imgUrl(m.poster_path, 'w500') : '';
      const title = m.title || m.name || '';
      const year = (m.release_date || m.first_air_date || '').slice(0,4) || '';
      const genres = (m.genres||[]).slice(0,3).map(g=>`<span class="pill">${esc(g.name)}</span>`).join('');
      const rating = (m.vote_average && m.vote_count>0) ? `‚≠ê${Number(m.vote_average).toFixed(1)}` : '';
      const runtime = (m.runtime ? `${m.runtime} min` : (Array.isArray(m.episode_run_time) && m.episode_run_time[0]) ? `${m.episode_run_time[0]} min` : '');
      const description = m.overview ? `<p class="description">${esc(m.overview)}</p>` : '';

      return `<article class="card" data-key="${esc(key)}" aria-grabbed="false">
        <img class="poster" src="${esc(poster)}" alt="Poster for ${esc(title)}" loading="lazy" />
        <div class="content">
          <h3 style="margin:0 0 6px">${esc(title)} ${year ? `<span class="pill" style="margin-left:6px">${esc(year)}</span>` : ''}</h3>
          <div class="row">${genres}</div>
          ${description}
        </div>
        <div class="actions">
          <div class="row" style="gap:8px">
            ${rating ? `<span class="pill">${esc(rating)}</span>` : ''}
            ${runtime ? `<span class="pill">${esc(runtime)}</span>` : ''}
            <span class="pill">${esc(m.media_type.toUpperCase())}</span>
          </div>
          <div class="row" style="gap:8px">
            <a class="btn-ghost" href="#" data-trailer="${esc(key)}" rel="noreferrer">–¢—Ä–µ–π–ª–µ—Ä</a>
            <button class="btn-ghost" data-remove="${esc(key)}" title="–£–¥–∞–ª–∏—Ç—å">–£–¥–∞–ª–∏—Ç—å</button>
            ${allowedDevice ? `<button class="btn-ghost" data-edit="${esc(key)}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–π–ª–µ—Ä">‚öôÔ∏è</button>` : ''}
          </div>
        </div>
      </article>`;
    }

    function renderList() {
      el.list.classList.remove('loading');
      el.loader.style.display = 'none';

      if (!state.order.length) {
        el.list.innerHTML = `<div class="card wide"><div class="content"><h3 style="margin:6px 0 6px">Your list is empty</h3><p class="subtitle">Search above and click a result to add a movie or TV show.</p></div></div>`;
        return;
      }
      el.list.innerHTML = state.order.map(key => cardTemplate(state.items[key], key)).join('');

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å DnD –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
      initPureJsDnD();
    }

    /* ==============================
       –û–ü–ï–†–ê–¶–ò–ò
       ============================== */
    async function addItem(type, id) {
      const key = `${type}_${id}`;
      if (state.items[key]) return;

      const m = await fetchDetails(type, id);
      if (m && !m.status_code) {
        m.media_type = type;
        m.customTrailerUrl = await searchYouTubeTrailer(m.title || m.name || '') || bestTrailerUrl(m) || '';
        state.items[key] = m;
        state.order.unshift(key);
        save();
        renderList();
      }
    }

    function openConfirmModal(title, key, card) {
      el.modalTitle.textContent = title;
      el.modal.style.display = 'flex';

      const close = () => { el.modal.style.display = 'none'; cleanup(); };
      const cleanup = () => {
        el.confirmDelete.removeEventListener('click', confirmHandler);
        el.cancelDelete.removeEventListener('click', close);
        el.modal.removeEventListener('click', backdrop);
      };
      const confirmHandler = () => {
        if (card) {
          card.classList.add('removing');
          setTimeout(() => {
            delete state.items[key];
            state.order = state.order.filter(x => x !== key);
            save();
            renderList();
          }, 500);
        } else {
          delete state.items[key];
          state.order = state.order.filter(x => x !== key);
          save();
          renderList();
        }
        close();
      };
      const backdrop = (e) => { if (e.target === el.modal) close(); };
      el.confirmDelete.addEventListener('click', confirmHandler, { once: true });
      el.cancelDelete.addEventListener('click', close);
      el.modal.addEventListener('click', backdrop);
    }

    function openEditModal(currentUrl, onSave) {
      el.trailerInput.value = currentUrl || '';
      el.editModal.style.display = 'flex';

      const close = () => { el.editModal.style.display = 'none'; cleanup(); };
      const cleanup = () => {
        el.saveTrailer.removeEventListener('click', saveHandler);
        el.cancelEdit.removeEventListener('click', close);
        el.editModal.removeEventListener('click', backdrop);
      };
      const saveHandler = () => { onSave(el.trailerInput.value.trim()); close(); };
      const backdrop = (e) => { if (e.target === el.editModal) close(); };

      el.saveTrailer.addEventListener('click', saveHandler, { once: true });
      el.cancelEdit.addEventListener('click', close);
      el.editModal.addEventListener('click', backdrop);
    }

    const doSearch = debounce(async () => {
      const q = el.search.value.trim();
      if (!q) { closeSuggestions(); return; }
      const data = await searchMulti(q);
      if (!data || data.Error) {
        el.suggestions.innerHTML = `<div class="suggestion" aria-disabled="true">${esc(data?.Error || 'No results')}</div>`;
        el.suggestions.classList.add('open');
        return;
      }
      openSuggestions(data.results);
    }, SEARCH_DELAY_MS);

    function highlight() {
      $$('.suggestion', el.suggestions).forEach((n, i) => n.setAttribute('aria-selected', String(i===state.selectedIndex)));
    }

    /* ==============================
       –ü–û–õ–ù–û–°–¢–¨–Æ –ß–ò–°–¢–´–ô JS DRAG & DROP
       ==============================
       –¶–µ–ª–∏:
       - –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –õ–ö–ú –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
       - –ë–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫
       - –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firebase
       - –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
    */
    function initPureJsDnD() {
      if (!allowedDevice) return;

      const container = el.list;

      // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è
      if (dragIndicator && dragIndicator.parentNode) {
        dragIndicator.parentNode.removeChild(dragIndicator);
      }
      dragIndicator = document.createElement('div');
      dragIndicator.className = 'drop-indicator';

      let draggedEl = null;
      let originIndex = -1;

      // –†–∞–∑—Ä–µ—à–∞—Ç—å drag —Ç–æ–ª—å–∫–æ –ø—Ä–∏ mousedown –õ–ö–ú –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö/—Å—Å—ã–ª–∫–∞—Ö
      function shouldStartDrag(evt) {
        if (evt.button !== 0) return false; // —Ç–æ–ª—å–∫–æ –õ–ö–ú
        const bad = evt.target.closest('.btn-ghost, button, a, [data-remove], [data-edit], [data-trailer]');
        return !bad;
      }

      // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫
      const getCards = () => $$('.card', container);

      // –û–±–Ω–æ–≤–∏—Ç—å state.order –∏—Å—Ö–æ–¥—è –∏–∑ DOM-–ø–æ—Ä—è–¥–∫–∞
      function commitOrderFromDOM() {
        const keys = getCards().map(c => c.getAttribute('data-key'));
        state.order = keys;
        save();
      }

      // –í—Å—Ç–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥/–ø–æ—Å–ª–µ target –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º—ã—à–∏
      function placeIndicator(targetCard, clientY) {
        const rect = targetCard.getBoundingClientRect();
        const isAfter = (clientY - rect.top) / rect.height > 0.5;
        container.insertBefore(dragIndicator, isAfter ? targetCard.nextSibling : targetCard);
      }

      // –°–Ω—è—Ç—å –æ–±—â–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
      function cleanupDragVisuals() {
        document.body.classList.remove('noselect');
        if (dragIndicator && dragIndicator.parentNode) {
          dragIndicator.parentNode.removeChild(dragIndicator);
        }
        getCards().forEach(c => c.classList.remove('dragging'));
      }

      // –ù–∞–≤–µ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É
      getCards().forEach((card) => {
        // –ù–∞–∑–Ω–∞—á–∏–º draggable –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ dnd
        card.addEventListener('mousedown', (e) => {
          if (!shouldStartDrag(e)) {
            card.setAttribute('draggable', 'false');
            return;
          }
          card.setAttribute('draggable', 'true');
        });

        // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–æ—Ç—á–µ—Ä –Ω–∞ mouseup: –µ—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å draggable
        card.addEventListener('mouseup', () => {
          // –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ dragstart, —É–±—Ä–∞—Ç—å draggable
          if (!isDragging) card.removeAttribute('draggable');
        });

        card.addEventListener('dragstart', (e) => {
          // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –∏–Ω–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç mousedown (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–π dnd),
          // –Ω–æ –Ω–∞–º –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –õ–ö–ú ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º dataTransfer –∏ —Ü–µ–ª—å.
          if (!shouldStartDrag({ button: 0, target: e.target })) {
            e.preventDefault();
            return;
          }

          isDragging = true;
          draggedEl = card;
          originIndex = getCards().indexOf(card);

          card.classList.add('dragging');
          card.setAttribute('aria-grabbed', 'true');
          document.body.classList.add('noselect');

          // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å –≤–∏–∑—É–∞–ª—å–Ω–æ "—á–∏—Å—Ç—ã–π"
          if (e.dataTransfer) {
            e.dataTransfer.effectAllowed = 'move';
            // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π drag image, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª —Å–µ—Ç–∫–µ
            const img = new Image();
            img.src =
              'data:image/svg+xml;charset=utf-8,' +
              encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"></svg>');
            e.dataTransfer.setDragImage(img, 0, 0);
          }
        });

        card.addEventListener('dragover', (e) => {
          // –†–∞–∑—Ä–µ—à–∏—Ç—å –±—Ä–æ—Å–∞–Ω–∏–µ
          e.preventDefault();
          if (!draggedEl) return;

          const target = e.target.closest('.card');
          if (!target || target === draggedEl) return;

          placeIndicator(target, e.clientY);
        });

        card.addEventListener('drop', (e) => {
          e.preventDefault();
          const target = e.target.closest('.card');
          if (!draggedEl || !target || target === draggedEl) return;

          // –í—Å—Ç–∞–≤–∫–∞ –≤ DOM –ø–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É
          if (dragIndicator && dragIndicator.parentNode === container) {
            container.insertBefore(draggedEl, dragIndicator);
          } else {
            // fallback: –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ ‚Äî —Ä–µ—à–∞–µ–º –ø–æ –∫—É—Ä—Å–æ—Ä—É
            const rect = target.getBoundingClientRect();
            const isAfter = (e.clientY - rect.top) / rect.height > 0.5;
            container.insertBefore(draggedEl, isAfter ? target.nextSibling : target);
          }
        });

        card.addEventListener('dragend', () => {
          // –°–±—Ä–æ—Å –≤–∏–∑—É–∞–ª–∞
          card.classList.remove('dragging');
          card.setAttribute('aria-grabbed', 'false');
          card.removeAttribute('draggable');

          // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Ä–µ–∞–ª—å–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏
          const newIndex = getCards().indexOf(card);
          if (newIndex !== originIndex && newIndex !== -1) {
            commitOrderFromDOM();
            // –†–µ—Ä–µ–Ω–¥–µ—Ä –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∫–ª—é—á–µ–π –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
            renderList();
          }

          cleanupDragVisuals();

          // –ö–æ—Ä–æ—Ç–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã onValue –Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–ª –ø–æ—Ä—è–¥–æ–∫ –≤ –º–æ–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
          setTimeout(() => { isDragging = false; }, 80);
          draggedEl = null;
          originIndex = -1;
        });
      });

      // DnD —Ç–∞–∫–∂–µ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ "–º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏" ‚Äî –ª–æ–≤–∏–º dragover –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
      container.addEventListener('dragover', (e) => {
        if (!draggedEl) return;
        e.preventDefault();
        const after = getCards().find(c => {
          const rect = c.getBoundingClientRect();
          return e.clientY < rect.top + rect.height / 2;
        });
        container.insertBefore(dragIndicator, after || null);
      });

      container.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!draggedEl) return;
        if (dragIndicator && dragIndicator.parentNode === container) {
          container.insertBefore(draggedEl, dragIndicator);
        }
      });
    }

    /* ==============================
       –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
       ============================== */
    document.addEventListener('DOMContentLoaded', () => {
      // –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —Å–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, dnd –Ω–µ –≤–∫–ª—é—á–∞—Ç—å
      if (!allowedDevice) {
        el.searchbar.style.display = 'none';
      } else {
        // –ü–æ–∏—Å–∫
        el.search.addEventListener('input', doSearch);
        el.search.addEventListener('keydown', (e) => {
          if (!el.suggestions.classList.contains('open')) return;
          const max = state.suggestions.length - 1;
          if (e.key === 'ArrowDown') { e.preventDefault(); state.selectedIndex = Math.min(max, state.selectedIndex + 1); highlight(); }
          else if (e.key === 'ArrowUp') { e.preventDefault(); state.selectedIndex = Math.max(0, state.selectedIndex - 1); highlight(); }
          else if (e.key === 'Enter') {
            if (state.selectedIndex >= 0) {
              const sel = state.suggestions[state.selectedIndex]; if (sel) addItem(sel.media_type, sel.id);
            } else if (state.suggestions[0]) {
              const sel = state.suggestions[0]; addItem(sel.media_type, sel.id);
            }
            closeSuggestions();
            el.search.select();
          } else if (e.key === 'Escape') { closeSuggestions(); }
        });

        el.suggestions.addEventListener('click', (e) => {
          const item = e.target.closest('.suggestion');
          if (!item) return;
          const id = item.getAttribute('data-id');
          const type = item.getAttribute('data-type');
          if (id && type) { addItem(type, id); closeSuggestions(); el.search.select(); }
        });

        document.addEventListener('click', (e) => {
          if (!el.searchbar.contains(e.target)) closeSuggestions();
        });
      }

      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º: —É–¥–∞–ª–∏—Ç—å / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / —Ç—Ä–µ–π–ª–µ—Ä
      el.list.addEventListener('click', async (e) => {
        const delBtn = e.target.closest('[data-remove]');
        const editBtn = e.target.closest('[data-edit]');
        const trailerLink = e.target.closest('[data-trailer]');

        if (delBtn) {
          const key = delBtn.getAttribute('data-remove');
          const m = state.items[key];
          if (!m) return;
          const title = m.title || m.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ';
          const card = el.list.querySelector(`.card[data-key="${key}"]`);
          openConfirmModal(title, key, card);
          return;
        }

        if (editBtn && allowedDevice) {
          const key = editBtn.getAttribute('data-edit');
          const m = state.items[key];
          if (!m) return;
          openEditModal(m.customTrailerUrl || '', (val) => {
            m.customTrailerUrl = val || '';
            save();
            renderList();
          });
          return;
        }

        if (trailerLink) {
          e.preventDefault();
          const key = trailerLink.getAttribute('data-trailer');
          const m = state.items[key];
          if (!m) return;
          const title = m.title || m.name || '';
          let url = m.customTrailerUrl || bestTrailerUrl(m);
          if (!url) url = await searchYouTubeTrailer(title);
          if (url) window.open(url, '_blank');
          else alert('–¢—Ä–µ–π–ª–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.');
        }
      });

      // –°—Ç–∞—Ä—Ç realtime-–ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
      subscribe();
      renderList(); // initPureJsDnD –≤—ã–∑–æ–≤–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏
    });
  </script>
</body>
</html>
