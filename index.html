<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–ø–∏—Å–æ–∫ —à–µ–¥–µ–≤—Ä–æ–≤ (TMDb)</title>
  <meta name="description" content="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–ø–∏—Å–æ–∫ –Ω–µ –ø—Ä–æ—Ö–æ–¥–Ω—è–∫–æ–≤, —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –õ–µ–æ–Ω–∏–¥–æ–º" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><text y='1em' font-size='96'>üé¨</text></svg>">
  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #12141a;
      --text: #e6e8f0;
      --muted: #9aa3b2;
      --accent: #6ee7b7;
      --accent-2: #93c5fd;
      --danger: #fca5a5;
      --ring: #334155;
      --card: #0f172a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(-45deg, #0f172a, #1e293b, #111827, #0b0c0f);
      background-size: 400% 400%;
      background-attachment: fixed;
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100dvh;
      animation: gradient 8s ease infinite;
    }
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    header { background: color-mix(in lab, var(--bg) 70%, transparent); border-bottom: 1px solid #1f2937 }
    .container { max-width: 980px; margin: 0 auto; padding: 16px }
    .title { display: flex; gap: 12px; align-items: center }
    .title h1 { margin: 0; font-weight: 800; letter-spacing: .2px; font-size: clamp(22px, 5vw, 30px) }
    .subtitle { margin: 6px 0 0; color: var(--muted); font-size: 14px }
    .searchbar { position: relative; margin-top: 14px }
    .searchbar input[type="text"] { width: 100%; padding: 14px 48px 14px 16px; border-radius: 14px; background: var(--panel); color: var(--text); border: 1px solid #1f2937; outline: none; font-size: 16px; box-shadow: inset 0 1px 0 rgba(255,255,255,.02), var(--shadow) }
    .searchbar input:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px rgba(147,197,253,.12), var(--shadow) }
    .searchbar .kbd { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font: 12px/1 monospace; color: var(--muted); opacity: .9 }
    .suggestions { position: absolute; inset: auto 0 0 0; transform: translateY(100%); background: var(--panel); border: 1px solid #1f2937; border-radius: 12px; margin-top: 8px; max-height: 60dvh; overflow: auto; box-shadow: var(--shadow); display: none; z-index: 100 }
    .suggestions.open { display: block }
    .suggestion { display: grid; grid-template-columns: 46px 1fr auto; gap: 12px; align-items: center; padding: 10px 12px; cursor: pointer }
    .suggestion:hover, .suggestion[aria-selected="true"] { background: #0b1220 }
    .suggestion img { width: 46px; height: 68px; object-fit: cover; border-radius: 8px; background: #0b1220 }
    .suggestion .meta { display: flex; flex-direction: column; gap: 4px }
    .pill { font-size: 12px; color: var(--muted); padding: 2px 8px; border: 1px solid #374151; border-radius: 999px }
    main .container { padding-top: 10px }
    .list {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 900px) { .list { grid-template-columns: repeat(6, 1fr) } }
    @media (max-width: 640px) { .listÂ®ÅÂäõ 0.5s ease-in-out; } 
    .list.sortable { touch-action: none; }
    .card {
      grid-column: span 4;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card);
      border: 1px solid #1f2937;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow), 0 0 10px rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
    }
    .sortable .card { cursor: grab }
    .card.wide { grid-column: span 6 }
    @media (max-width: 640px) { .card, .card.wide { grid-column: span 4 } }
    .poster { width: 100%; aspect-ratio: 3 / 4.2; object-fit: cover; background: #0b1220 }
    .content { padding: 12px 14px 16px; flex: 0 0 auto; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 6px 0 }
    .description {
      color: var(--muted);
      line-height: 1.5;
      margin: 6px 0 0;
      font-size: 14px;
    }
    .actions {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      border-top: 1px solid #1f2937;
      background: #0c111b;
      flex-wrap: wrap
    }
    button, .btn {
      appearance: none;
      border: 1px solid #2b3443;
      background: #111827;
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: var(--shadow)
    }
    button:hover { background: #0f172a; border-color: #3b475a }
    .btn-ghost {
      background: transparent;
      border: 1px solid #374151;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      text-align: center;
      line-height: 1.5;
      padding: 10px 14px;
      border-radius: 12px;
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      box-sizing: border-box;
      min-width: 80px;
      font-size: 16px
    }
    .btn-ghost:hover { background: #0f172a; border-color: #3b475a }
    .btn-danger { border-color: #7f1d1d; background: #1f0f12 }
    .btn-danger:hover { background: #2b0f12; border-color: #991b1b }
    footer { color: var(--muted); font-size: 12px; border-top: 1px solid #1f2937 }
    a { color: var(--accent-2); text-decoration: none }
    a:hover { text-decoration: underline }
    .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100 }
    .modal-content { background: var(--card); padding: 10px 20px 20px; border-radius: var(--radius); border: 1px solid #1f2937; box-shadow: var(--shadow); width: 90%; max-width: 400px; text-align: center }
    .modal-content p { margin: 0 0 15px; color: var(--muted); font-size: 16px }
    .modal-actions, .edit-actions { display: flex; justify-content: center; gap: 10px }
    @media (max-width: 640px) {
      .modal-content { max-width: 90%; padding: 15px }
      .modal-content p { font-size: 14px }
      .modal-actions button, .modal-actions .btn { padding: 8px 12px; font-size: 14px }
    }
    .edit-modal-content { background: var(--card); padding: 20px; border-radius: var(--radius); border: 1px solid #1f2937; box-shadow: var(--shadow); width: 90%; max-width: 500px; text-align: center }
    .edit-modal-content h3 { margin: 0 0 15px; color: var(--text) }
    .edit-modal-content input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #1f2937; border-radius: 8px; background: var(--panel); color: var(--text); font-size: 14px }
    .edit-modal-content input:focus { border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(147,197,253,.12) }
    .loader { border: 8px solid #0b0c0f; border-top: 8px solid #6ee7b7; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg) } 100% { transform: translate(-50%, -50%) rotate(360deg) } }
    #list.loading { display: none }
    .loader-container { position: relative; min-height: 200px; width: 100% }
    body.noselect { user-select: none }
    .card.dragging { opacity: 0.6; cursor: grabbing; }
    .card.removing { opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0s linear 0.5s; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="module">
    'use strict'
    const TMDB_API_KEY = "166bdfecdc09d46826d8662b9627ad27";
    const TMDB_IMG_BASE = "https://image.tmdb.org/t/p/";
    const LANGUAGE = "ru";
    const YOUTUBE_API_KEY = "AIzaSyCUHWrkVFi1UO1y8NKSkWtrT_W1aZpdBDM";
    const SEARCH_DELAY_MS = 350;
    const ALLOWED_DEVICE_ID = "30a62442-ecd5-4abf-9b51-22b34ae85d2e|Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
    import React, { useState, useEffect, useRef, useCallback } from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18';
    import SortableList, { SortableItem } from 'https://esm.sh/react-easy-sort';
    import { arrayMoveImmutable } from 'https://esm.sh/array-move';

    const firebaseConfig = {
      apiKey: "AIzaSyDu8R38EkqOxBDkcgfnYf5mBTCosQsOoGA",
      authDomain: "my-movie-tv-lis.firebaseapp.com",
      projectId: "my-movie-tv-lis",
      storageBucket: "my-movie-tv-lis.firebasestorage.app",
      messagingSenderId: "470112487115",
      appId: "1:470112487115:web:a0dba8f948514eaf3e3d4e",
      measurementId: "G-JLCYQH6XEE"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    function getDeviceId() {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        deviceId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
        });
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId + '|' + navigator.userAgent;
    }

    function apiUrl(path, params = {}) {
      const base = new URL('https://api.themoviedb.org/3' + path);
      const sp = new URLSearchParams({ api_key: TMDB_API_KEY, language: LANGUAGE, ...params });
      base.search = sp.toString();
      return base.toString();
    }
    const imgUrl = (path, size='w500') => path ? `${TMDB_IMG_BASE}${size}${path}` : '';

    async function searchYouTubeTrailer(title) {
      const q = `${encodeURIComponent(title)} —Ç—Ä–µ–π–ª–µ—Ä —Ä—É—Å—Å–∫–∏–π`;
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&key=${YOUTUBE_API_KEY}&regionCode=RU&maxResults=1&type=video`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data?.items?.length) return `https://www.youtube.com/watch?v=${data.items[0].id.videoId}`;
      } catch (e) {
        console.warn('YouTube API error:', e);
      }
      return null;
    }

    async function searchMulti(q) {
      if (!TMDB_API_KEY) return { results: [] };
      const url = apiUrl('/search/multi', { query: q, include_adult: 'false' });
      try {
        const res = await fetch(url);
        if (!res.ok) return { results: [] };
        const data = await res.json();
        const items = (data?.results||[]).filter(r=>r.media_type==='movie'||r.media_type==='tv').slice(0,12);
        return { results: items };
      } catch (e) {
        console.warn('TMDb search error:', e);
        return { results: [] };
      }
    }

    async function fetchDetails(type, id) {
      const url = apiUrl(`/${type}/${id}`, { append_to_response: 'videos' });
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch details');
        return await res.json();
      } catch (e) {
        console.warn('TMDb details error:', e);
        return null;
      }
    }

    function bestTrailerUrl(details) {
      const vids = details?.videos?.results || [];
      const pick = vids.find(v => v.site==='YouTube' && v.type==='Trailer' && v.official && v.iso_639_1==='ru')
        || vids.find(v => v.site==='YouTube' && v.type==='Trailer' && v.iso_639_1==='ru')
        || vids.find(v => v.site==='YouTube' && v.type==='Teaser' && v.iso_639_1==='ru');
      return pick ? `https://www.youtube.com/watch?v=${pick.key}` : '';
    }

    function debounce(fn, ms) {
      let t;
      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      };
    }

    const Card = ({ m, keyProp, allowedDevice, onDelete, onEdit, onTrailer }) => {
      if (!m) return null;
      const poster = imgUrl(m.poster_path, 'w500') || 'https://via.placeholder.com/300x420?text=No+Poster';
      const title = m.title || m.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const year = (m.release_date || m.first_air_date || '').slice(0, 4) || '';
      const genres = (m.genres || []).slice(0, 3).map(g => <span key={g.id} className="pill">{g.name}</span>);
      const rating = (m.vote_average && m.vote_count > 0) ? `‚≠ê${m.vote_average.toFixed(1)}` : '';
      const runtime = m.runtime ? `${m.runtime} min` : (Array.isArray(m.episode_run_time) && m.episode_run_time[0] ? `${m.episode_run_time[0]} min` : '');
      const description = m.overview ? <p className="description">{m.overview}</p> : null;
      return (
        <article className="card" data-key={keyProp} aria-grabbed="false">
          <img className="poster" src={poster} alt={`Poster for ${title}`} loading="lazy" />
          <div className="content">
            <h3 style={{ margin: '0 0 6px' }}>{title} {year ? <span className="pill" style={{ marginLeft: '6px' }}>{year}</span> : null}</h3>
            <div className="row">{genres}</div>
            {description}
          </div>
          <div className="actions">
            <div className="row" style={{ gap: '8px' }}>
              {rating ? <span className="pill">{rating}</span> : null}
              {runtime ? <span className="pill">{runtime}</span> : null}
              <span className="pill">{m.media_type.toUpperCase()}</span>
            </div>
            <div className="row" style={{ gap: '8px' }}>
              <a className="btn-ghost" href="#" onClick={(e) => { e.preventDefault(); onTrailer(); }} rel="noreferrer">–¢—Ä–µ–π–ª–µ—Ä</a>
              <button className="btn-ghost" onClick={onDelete} title="–£–¥–∞–ª–∏—Ç—å">–£–¥–∞–ª–∏—Ç—å</button>
              {allowedDevice ? <button className="btn-ghost" onClick={onEdit} title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–π–ª–µ—Ä">‚öôÔ∏è</button> : null}
            </div>
          </div>
        </article>
      );
    };

    const App = () => {
      const [items, setItems] = useState({});
      const [order, setOrder] = useState([]);
      const [suggestions, setSuggestions] = useState([]);
      const [selectedIndex, setSelectedIndex] = useState(-1);
      const [isLoading, setIsLoading] = useState(true);
      const [searchValue, setSearchValue] = useState('');
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [deleteKey, setDeleteKey] = useState(null);
      const [deleteTitle, setDeleteTitle] = useState('');
      const [showEditModal, setShowEditModal] = useState(false);
      const [editKey, setEditKey] = useState(null);
      const [trailerValue, setTrailerValue] = useState('');
      const [error, setError] = useState(null);
      const deviceId = getDeviceId();
      const allowedDevice = deviceId === ALLOWED_DEVICE_ID;
      const localUpdatedAtRef = useRef(0);
      const suppressRemoteRef = useRef(false);
      const isDraggingRef = useRef(false);
      const searchbarRef = useRef(null);

      const doSearch = useCallback(debounce(async (q) => {
        if (!q) {
          setSuggestions([]);
          return;
        }
        try {
          const data = await searchMulti(q);
          if (data.Error) {
            setSuggestions([]);
            setError(data.Error);
            return;
          }
          setSuggestions(data.results || []);
          setSelectedIndex(-1);
          setError(null);
        } catch (e) {
          setSuggestions([]);
          setError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
        }
      }, SEARCH_DELAY_MS), []);

      const save = () => {
        const payload = { items, order, updatedAt: Date.now(), device: deviceId };
        localUpdatedAtRef.current = payload.updatedAt;
        suppressRemoteRef.current = true;
        setTimeout(() => { suppressRemoteRef.current = false; }, 800);
        set(ref(database, 'tmdbList'), payload).catch(err => {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
          setError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
        });
      };

      useEffect(() => {
        const unsubscribe = onValue(ref(database, 'tmdbList'), (snapshot) => {
          const data = snapshot.val();
          if (!data) {
            setIsLoading(false);
            setError('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ');
            return;
          }
          if (isDraggingRef.current || suppressRemoteRef.current) return;
          if (data.updatedAt < localUpdatedAtRef.current) return;
          const newItems = data.items || {};
          for (const k in newItems) {
            const m = newItems[k];
            if (!m.customTrailerUrl) m.customTrailerUrl = bestTrailerUrl(m) || '';
          }
          setItems(newItems);
          setOrder(data.order || []);
          setIsLoading(false);
          setError(null);
        }, (error) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
          setIsLoading(false);
        });
        return unsubscribe;
      }, []);

      useEffect(() => {
        const handleClickOutside = (e) => {
          if (searchbarRef.current && !searchbarRef.current.contains(e.target)) {
            setSuggestions([]);
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, []);

      const addItem = async (type, id) => {
        const key = `${type}_${id}`;
        if (items[key]) return;
        const m = await fetchDetails(type, id);
        if (m && !m.status_code) {
          m.media_type = type;
          m.customTrailerUrl = await searchYouTubeTrailer(m.title || m.name || '') || bestTrailerUrl(m) || '';
          setItems(prev => ({ ...prev, [key]: m }));
          setOrder(prev => [key, ...prev]);
          save();
        } else {
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç');
        }
      };

      const handleSortEnd = (oldIndex, newIndex) => {
        isDraggingRef.current = true;
        const newOrder = arrayMoveImmutable(order, oldIndex, newIndex);
        setOrder(newOrder);
        save();
        setTimeout(() => { isDraggingRef.current = false; }, 100);
      };

      const handleSearchChange = (e) => {
        setSearchValue(e.target.value);
        doSearch(e.target.value.trim());
      };

      const handleSearchKeyDown = (e) => {
        if (suggestions.length === 0) return;
        const max = suggestions.length - 1;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          setSelectedIndex(Math.min(max, selectedIndex + 1));
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          setSelectedIndex(Math.max(-1, selectedIndex - 1));
        } else if (e.key === 'Enter') {
          let sel;
          if (selectedIndex >= 0) {
            sel = suggestions[selectedIndex];
          } else if (suggestions[0]) {
            sel = suggestions[0];
          }
          if (sel) {
            addItem(sel.media_type, sel.id);
            setSuggestions([]);
            setSearchValue('');
          }
        } else if (e.key === 'Escape') {
          setSuggestions([]);
        }
      };

      return (
        <>
          <header>
            <div className="container">
              <div className="title">
                <div style={{ fontSize: '26px' }}>üé¨</div>
                <div>
                  <h1>–°–ø–∏—Å–æ–∫ —à–µ–¥–µ–≤—Ä–æ–≤</h1>
                  <p className="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–ø–∏—Å–æ–∫ –Ω–µ –ø—Ä–æ—Ö–æ–¥–Ω—è–∫–æ–≤, —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –õ–µ–æ–Ω–∏–¥–æ–º</p>
                </div>
              </div>
              {allowedDevice && (
                <div className="searchbar" role="combobox" aria-expanded={suggestions.length > 0} aria-owns="suggestion-list" ref={searchbarRef}>
                  <input
                    type="text"
                    placeholder="Search for a film or show‚Ä¶"
                    autoComplete="off"
                    aria-autocomplete="list"
                    aria-controls="suggestion-list"
                    value={searchValue}
                    onChange={handleSearchChange}
                    onKeyDown={handleSearchKeyDown}
                  />
                  <span className="kbd">Enter ‚Üµ</span>
                  <div className={`suggestions ${suggestions.length > 0 ? 'open' : ''}`} role="listbox" aria-label="Search suggestions">
                    {suggestions.length === 0 && searchValue && !error ? (
                      <div className="suggestion" aria-disabled="true">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
                    ) : (
                      suggestions.map((it, idx) => (
                        <div
                          key={it.id}
                          className="suggestion"
                          role="option"
                          data-type={it.media_type}
                          data-id={it.id}
                          aria-selected={idx === selectedIndex}
                          onClick={() => {
                            addItem(it.media_type, it.id);
                            setSuggestions([]);
                            setSearchValue('');
                          }}
                        >
                          <img src={imgUrl(it.poster_path, 'w154') || 'https://via.placeholder.com/46x68?text=No+Image'} alt="" loading="lazy" />
                          <div className="meta">
                            <div style={{ fontWeight: 700 }}>{it.title || it.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                            <div className="pill">{(it.release_date || it.first_air_date || '').slice(0, 4) || ''}</div>
                          </div>
                          <div className="pill">{it.media_type}</div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}
            </div>
          </header>
          <main>
            <div className="container">
              <div className="loader-container">
                {isLoading && <div className="loader"></div>}
                {!isLoading && error && (
                  <div className="card wide">
                    <div className="content">
                      <h3 style={{ margin: '6px 0 6px' }}>–û—à–∏–±–∫–∞</h3>
                      <p className="subtitle">{error}</p>
                    </div>
                  </div>
                )}
                {!isLoading && !error && (
                  order.length === 0 ? (
                    <div className="card wide">
                      <div className="content">
                        <h3 style={{ margin: '6px 0 6px' }}>–í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç</h3>
                        <p className="subtitle">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –≤—ã—à–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º –∏–ª–∏ —à–æ—É.</p>
                      </div>
                    </div>
                  ) : (
                    <SortableList
                      onSortEnd={handleSortEnd}
                      className={`list ${allowedDevice ? 'sortable' : ''}`}
                      draggedItemClassName="dragging"
                      allowDrag={allowedDevice}
                      lockAxis="y"
                    >
                      {order.map((key, index) => (
                        <SortableItem key={key}>
                          <Card
                            m={items[key]}
                            keyProp={key}
                            allowedDevice={allowedDevice}
                            onDelete={() => {
                              setDeleteKey(key);
                              setDeleteTitle(items[key]?.title || items[key]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
                              setShowDeleteModal(true);
                            }}
                            onEdit={() => {
                              setEditKey(key);
                              setTrailerValue(items[key]?.customTrailerUrl || '');
                              setShowEditModal(true);
                            }}
                            onTrailer={async () => {
                              const m = items[key];
                              if (!m) return;
                              const title = m.title || m.name || '';
                              let url = m.customTrailerUrl || bestTrailerUrl(m);
                              if (!url) url = await searchYouTubeTrailer(title);
                              if (url) window.open(url, '_blank');
                              else alert('–¢—Ä–µ–π–ª–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                            }}
                          />
                        </SortableItem>
                      ))}
                    </SortableList>
                  )
                )}
              </div>
            </div>
          </main>
          <footer>
            <div className="container">
              Data from TMDb (The Movie Database). This product uses the TMDb API but is not endorsed or certified by TMDb.
            </div>
          </footer>
          {showDeleteModal && (
            <div className="modal" style={{ display: 'flex' }} onClick={(e) => { if (e.target.className === 'modal') setShowDeleteModal(false); }}>
              <div className="modal-content">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <strong>{deleteTitle}</strong>?</p>
                <div className="modal-actions">
                  <button
                    className="btn btn-danger"
                    onClick={() => {
                      setItems((prev) => { const n = { ...prev }; delete n[deleteKey]; return n; });
                      setOrder((prev) => prev.filter((x) => x !== deleteKey));
                      save();
                      setShowDeleteModal(false);
                    }}
                  >
                    –î–∞
                  </button>
                  <button className="btn btn-ghost" onClick={() => setShowDeleteModal(false)}>–ù–µ—Ç</button>
                </div>
              </div>
            </div>
          )}
          {showEditModal && (
            <div className="modal" style={{ display: 'flex' }} onClick={(e) => { if (e.target.className === 'modal') setShowEditModal(false); }}>
              <div className="edit-modal-content">
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–π–ª–µ—Ä</h3>
                <input
                  type="text"
                  value={trailerValue}
                  onChange={(e) => setTrailerValue(e.target.value)}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ URL —Ç—Ä–µ–π–ª–µ—Ä–∞"
                />
                <div className="edit-actions">
                  <button
                    className="btn btn-danger"
                    onClick={() => {
                      setItems((prev) => ({
                        ...prev,
                        [editKey]: { ...prev[editKey], customTrailerUrl: trailerValue.trim() },
                      }));
                      save();
                      setShowEditModal(false);
                    }}
                  >
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                  <button className="btn btn-ghost" onClick={() => setShowEditModal(false)}>–û—Ç–º–µ–Ω–∞</button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
